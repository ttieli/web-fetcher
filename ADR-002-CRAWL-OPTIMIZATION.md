# ADR-002: 全站爬取优化架构决策

## 状态
提议中 (Proposed)

## 背景
当前的全站爬取功能在处理大型网站时存在性能瓶颈：
1. 所有链接都进入BFS队列，包括无效链接
2. 页面内容全部存储在内存中，导致内存使用过高
3. 政府网站的层级结构没有得到有效利用
4. 缺乏针对不同网站类型的优化策略

## 决策
采用渐进式架构优化方案，分两个阶段实施：

### 阶段1：基础性能优化
1. **链接预过滤**：在链接进入队列前进行有效性检查
2. **批量处理**：优化链接提取和处理的批量操作
3. **内存管理**：实现流式处理和分批写入机制

### 阶段2：智能爬取策略
1. **网站类型检测**：自动识别政府网站
2. **栏目优先策略**：为政府网站提供栏目优先爬取
3. **策略自动降级**：新策略失败时自动降级到默认策略

## 架构原则

### 1. 向后兼容性原则
- API接口保持不变
- 默认行为与现有版本一致
- 新功能通过可选参数启用

**理由**：确保现有用户不受影响，降低升级风险

### 2. 策略驱动原则
- 通过配置参数选择爬取策略
- 支持运行时策略切换
- 策略失败自动降级

**理由**：提高系统灵活性，适应不同网站类型

### 3. 性能优先原则
- 内存使用优化
- 网络请求效率优化
- 避免重复计算

**理由**：解决大规模爬取的性能瓶颈

### 4. 渐进式升级原则
- 分阶段实施
- 每阶段都有明确的成功标准
- 支持回滚和降级

**理由**：降低实施风险，确保系统稳定性

## 技术决策

### 1. 链接预过滤实现
**决策**：在`crawl_site`函数中添加预过滤逻辑

**备选方案**：
- A. 在`extract_internal_links`中过滤
- B. 在队列处理时过滤  
- C. 在链接加入队列前过滤 ✅

**选择理由**：
- 选项C能最早阻止无效链接，减少后续处理开销
- 保持现有函数职责单一性
- 易于测试和维护

### 2. 内存管理策略
**决策**：实现分批写入和内存阈值管理

**备选方案**：
- A. 所有内容保存在内存中
- B. 实时写入磁盘
- C. 分批写入和内存管理 ✅

**选择理由**：
- 选项C平衡了性能和内存使用
- 支持大规模爬取而不会内存溢出
- 保持合理的磁盘I/O频率

### 3. 政府网站检测方式
**决策**：域名检查 + HTML特征识别

**备选方案**：
- A. 仅域名检查
- B. 仅HTML特征检查
- C. 域名 + HTML特征检查 ✅

**选择理由**：
- 选项C提供最高的检测准确性
- 域名检查快速但可能遗漏
- HTML特征检查准确但成本较高
- 结合两者达到最佳平衡

### 4. 栏目识别策略
**决策**：多选择器策略 + 关键词优先级

**备选方案**：
- A. 固定CSS选择器
- B. 机器学习识别
- C. 多选择器 + 关键词策略 ✅

**选择理由**：
- 选项C在准确性和实现复杂度间取得平衡
- 多选择器提高兼容性
- 关键词优先级符合政府网站特点
- 避免机器学习的复杂性和依赖

## 实施策略

### 阶段1实施重点
1. **最小化风险**：所有优化都是增量式的
2. **保持兼容**：通过feature flag控制新功能
3. **性能验证**：建立性能基准测试

### 阶段2实施重点  
1. **智能检测**：高准确率的网站类型检测
2. **策略降级**：确保新策略失败时的稳定性
3. **用户体验**：政府网站爬取效率显著提升

## 质量保证

### 测试策略
1. **单元测试**：每个组件独立测试
2. **集成测试**：策略切换和降级测试
3. **性能测试**：基准对比和负载测试
4. **兼容性测试**：确保API向后兼容

### 成功指标
1. **阶段1**：
   - 性能提升15-25%
   - 内存使用降低30%
   - 零兼容性问题

2. **阶段2**：
   - 政府网站检测准确率>90%
   - 栏目识别成功率>85%
   - 政府网站爬取效率提升50%

## 风险和缓解

### 主要风险
1. **性能回归**：优化可能带来意外的性能问题
2. **兼容性破坏**：新功能可能影响现有行为
3. **复杂度增加**：多策略可能增加维护难度
4. **检测准确性**：网站类型检测可能出现误判

### 缓解措施
1. **全面测试**：建立完整的测试套件
2. **Feature Flag**：支持功能开关和降级
3. **监控告警**：实时监控性能和错误率
4. **回滚机制**：快速回滚到稳定版本

## 后果
1. **正面影响**：
   - 大幅提升大规模爬取性能
   - 为政府网站提供优化体验
   - 提高系统可扩展性
   - 增强系统健壮性

2. **负面影响**：
   - 代码复杂度适度增加
   - 测试用例数量增加
   - 需要更多的配置管理

3. **长期影响**：
   - 建立了可扩展的策略框架
   - 为未来的网站类型优化打下基础
   - 提升了系统的适应性

## 相关文档
- [技术架构规格](./TECHNICAL_ARCHITECTURE_SPEC.md)
- [测试验证规格](./TEST_VALIDATION_SPEC.md)
- [原始需求分析](./REPAIR_TASK_LIST.md)