# 3_建立统一错误处理框架
# Establish Unified Error Handling Framework

## 背景 / Background
- 现有失败处理散落在 `selenium_fetcher.py`、`webfetcher.py` 等处，缺乏统一结构，后续扩展（如 Playwright）时难以维护。
  Current failure handling is scattered across multiple files, lacking unified structure for future extensions.
- 之前方案建议新增 `error_reporter.py`，封装错误分类、排错建议与 Markdown 生成。
  Previous plan suggested adding `error_reporter.py` to encapsulate error classification and troubleshooting.

## 目标 / Goals
- 在项目中引入独立的错误报告模块，统一管理错误类型、排查步骤和输出模板。
  Introduce independent error reporting module for unified error management.
- 为未来的多引擎扩展（Selenium、Playwright、CDP）提供一致的错误处理接口。
  Provide consistent error handling interface for future multi-engine extensions.

## 验收标准 / Acceptance Criteria
1. 新增 `error_reporter.py`，提供错误分类、排障建议、失败 Markdown 生成等能力。
   Add `error_reporter.py` with error classification, troubleshooting, and failure report generation.
2. `webfetcher.py` 与 `selenium_fetcher.py` 调用该模块，去除重复代码。
   Integrate module into existing code to remove duplication.
3. 单元测试覆盖至少三类错误场景的处理。
   Unit tests cover at least three error scenarios.
4. 文档说明如何扩展新的错误类型。
   Documentation on extending new error types.

## 实施步骤 / Implementation Steps

### 步骤1：模块架构设计 / Step 1: Module Architecture Design
定义错误报告模块的核心组件：
Define core components of error reporting module:
```python
# error_reporter.py
class ErrorType(Enum):
    CHROME_CONNECTION = "chrome_connection"
    SELENIUM_MISSING = "selenium_missing"
    PAGE_LOAD_TIMEOUT = "page_load_timeout"
    PERMISSION_DENIED = "permission_denied"

class ErrorReporter:
    def classify_error(self, exception)
    def get_troubleshooting_guide(self, error_type)
    def generate_failure_markdown(self, error_context)
    def format_terminal_message(self, error_type)
```

### 步骤2：错误分类实现 / Step 2: Error Classification
实现自动错误分类和解决方案映射：
Implement automatic error classification and solution mapping:
- 根据异常类型和消息内容识别错误类别
- 为每种错误类型定义标准解决方案
- 支持中英双语输出

### 步骤3：集成到现有代码 / Step 3: Integration
替换现有的错误处理代码：
Replace existing error handling code:
- 在 `webfetcher.py` 中调用错误报告器
- 在 `selenium_fetcher.py` 中使用统一接口
- 保持向后兼容性

### 步骤4：测试与文档 / Step 4: Testing & Documentation
- 编写单元测试覆盖各种错误场景
- 创建集成测试验证端到端流程
- 更新文档说明使用方法

## 架构优势 / Architecture Benefits
1. **可维护性 / Maintainability**：集中管理所有错误处理逻辑
2. **可扩展性 / Extensibility**：轻松添加新的错误类型和引擎支持
3. **一致性 / Consistency**：统一的错误报告格式和用户体验
4. **可测试性 / Testability**：独立模块便于单元测试

## 备注 / Notes
- 建议在完成Task 1和Task 2后再推进本任务，确保接口稳定。
  Recommend starting after Task 1 and Task 2 to ensure stable interfaces.
- 保持最小可行实现，避免过度工程。
  Keep minimal viable implementation, avoid over-engineering.
- 此框架将为项目长期维护提供重要基础。
  This framework provides important foundation for long-term maintenance.
