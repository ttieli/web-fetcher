#!/usr/bin/env python3
"""
Enhanced WebFetcher with Safari Fallback
========================================

Drop-in replacement for wf command that adds intelligent Safari-based
fallback for sites with CAPTCHA or anti-bot protection.

Usage:
    ./enhanced_wf URL [output_dir] [options]
    
Environment Variables:
    WF_ENABLE_SAFARI_FALLBACK - Enable/disable Safari fallback (default: 1)
    WF_SAFARI_TIMEOUT - Safari page load timeout in seconds (default: 60)
    WF_MIN_CONTENT_LENGTH - Minimum valid content length (default: 1000)
    WF_SAFARI_GOV_ONLY - Only use Safari for government sites (default: 0)

Examples:
    # Basic usage
    ./enhanced_wf "https://www.ccdi.gov.cn/..." output/
    
    # Disable Safari fallback
    WF_ENABLE_SAFARI_FALLBACK=0 ./enhanced_wf "https://example.com" output/
    
    # Government sites only
    WF_SAFARI_GOV_ONLY=1 ./enhanced_wf "https://www.ccdi.gov.cn/..." output/
"""

import os
import sys
import logging
from pathlib import Path

# Setup paths
SCRIPT_DIR = Path(__file__).resolve().parent
WEBFETCHER_DIR = SCRIPT_DIR.parent

# Add paths for imports
sys.path.insert(0, str(SCRIPT_DIR))
sys.path.insert(0, str(WEBFETCHER_DIR))

# Configure logging
logging.basicConfig(
    level=logging.INFO if os.environ.get('WF_VERBOSE') else logging.WARNING,
    format='%(asctime)s - %(name)s - %(levelname)s - %(message)s'
)
logger = logging.getLogger('enhanced_wf')


def check_environment():
    """Check and display environment configuration."""
    import platform
    
    logger.info("Enhanced WebFetcher with Safari Fallback")
    logger.info("=" * 50)
    
    # Check platform
    if platform.system() != 'Darwin':
        logger.warning("Safari fallback only available on macOS")
        logger.warning("Running in standard mode")
        return False
    
    # Check Safari fallback settings
    safari_enabled = os.environ.get('WF_ENABLE_SAFARI_FALLBACK', '1') == '1'
    if safari_enabled:
        logger.info("Safari fallback: ENABLED")
        logger.info(f"  Timeout: {os.environ.get('WF_SAFARI_TIMEOUT', '60')}s")
        logger.info(f"  Min content: {os.environ.get('WF_MIN_CONTENT_LENGTH', '1000')} chars")
        logger.info(f"  Gov only: {os.environ.get('WF_SAFARI_GOV_ONLY', '0') == '1'}")
    else:
        logger.info("Safari fallback: DISABLED")
    
    return safari_enabled


def main():
    """Enhanced main function with Safari fallback support."""
    
    # Check environment and configuration
    safari_available = check_environment()
    
    try:
        # Import the safari fallback wrapper
        if safari_available:
            logger.info("Loading Safari fallback enhancement...")
            from safari_fallback_wrapper import install_safari_fallback
            
            # Install the enhancement
            install_safari_fallback()
            logger.info("Safari fallback installed successfully")
        
        # Import and run webfetcher
        import webfetcher
        return webfetcher.main()
        
    except ImportError as e:
        logger.error(f"Failed to import required modules: {e}")
        logger.error("Make sure safari_fallback_wrapper.py and ccdi_production_extractor.py are in the same directory")
        return 1
        
    except Exception as e:
        logger.error(f"Unexpected error: {e}")
        return 1


if __name__ == "__main__":
    sys.exit(main())